name: Upgrade Event Handler

on:
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  upgrade:
    runs-on: self-hosted
    steps:
      - name: Upgrade thepopebot
        run: |
          docker exec thepopebot-event-handler bash -c '
            export GH_TOKEN=$(grep "^GH_TOKEN=" /app/.env | cut -d= -f2-)
            echo "${GH_TOKEN}" | gh auth login --with-token
            gh auth setup-git

            REPO_URL=$(git -C /app remote get-url origin)
            WORK_DIR=$(mktemp -d)
            git clone --depth 1 "$REPO_URL" "$WORK_DIR"
            cd "$WORK_DIR"

            npm install
            npm update thepopebot

            git add -A
            if ! git diff --cached --quiet; then
              VERSION=$(node -p "require('./node_modules/thepopebot/package.json').version")
              BRANCH="upgrade/thepopebot-${VERSION}-$(date +%s)"
              git checkout -b "$BRANCH"
              git commit -m "chore: upgrade thepopebot"
              git push origin "$BRANCH"
              gh pr create --title "chore: upgrade thepopebot" --body "Automated upgrade via upgrade-event-handler workflow." --base main --head "$BRANCH"
              gh pr merge "$BRANCH" --squash --auto --delete-branch
            else
              echo "No changes â€” thepopebot is already up to date."
            fi

            rm -rf "$WORK_DIR"
          '
